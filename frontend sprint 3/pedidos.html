<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mis Pedidos - EcoMarket</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link href="assets/css/style.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>
    <!-- NAVBAR -->
    <nav class="navbar navbar-expand-lg navbar-dark sticky-top" style="background-color: #008c5a;">
        <div class="container-fluid">
            <!-- Logo -->
            <a class="navbar-brand fw-bold" href="index.html">EcoMarket</a>

            <!-- Iconos fijos a la derecha (siempre visibles) -->
            <div class="d-flex align-items-center gap-2 order-lg-3">
                <!-- Dropdown Usuario -->
                <div class="dropdown">
                    <a href="#" class="text-white" role="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-person fs-5"></i>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown" id="userDropdownMenu">
                        <!-- El contenido se genera dinámicamente con JavaScript -->
                    </ul>
                </div>

                <!-- Carrito -->
                <a href="carrito.html" class="text-white position-relative">
                    <i class="bi bi-cart fs-5"></i>
                    <span id="cart-count" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="display: none;">0</span>  
                </a>
            </div>

            <!-- Botón Hamburguesa -->
            <button class="navbar-toggler custom-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="custom-toggler-icon">
                    <span></span>
                    <span></span>
                    <span></span>
                </span>
            </button>

            <!-- Links del menú -->
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item"><a class="nav-link" href="index.html">Inicio</a></li>
                    <li class="nav-item"><a class="nav-link" href="catalogo.html">Catálogo</a></li>
                    <li class="nav-item"><a class="nav-link" href="index.html#nosotros">Nosotros</a></li>
                    <li class="nav-item"><a class="nav-link active" href="#">Mis Pedidos</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- CONTENIDO PRINCIPAL -->
    <div class="container py-5" style="margin-top: 76px;">
        <!-- Header de la página -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex align-items-center mb-4">
                    <div class="me-3">
                        <div class="bg-success rounded-circle d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                            <i class="bi bi-bag-check text-white fs-4"></i>
                        </div>
                    </div>
                    <div>
                        <h2 class="mb-1 fw-bold">Mis Pedidos</h2>
                        <p class="text-muted mb-0">Revisa el estado de tus compras</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mensaje de usuario no logueado -->
        <div id="not-logged-in" class="text-center py-5" style="display: none;">
            <div class="mb-4">
                <i class="bi bi-person-x" style="font-size: 5rem; color: #6c757d;"></i>
            </div>
            <h4 class="text-muted mb-3">Debes iniciar sesión para ver tus pedidos</h4>
            <p class="text-muted mb-4">Accede a tu cuenta para revisar el historial de tus compras.</p>
            <a href="login.html" class="btn btn-success btn-lg">
                <i class="bi bi-person-check me-2"></i>Iniciar sesión
            </a>
        </div>

        <!-- Lista de pedidos vacía -->
        <div id="empty-orders" class="text-center py-5" style="display: none;">
            <div class="mb-4">
                <i class="bi bi-bag-x" style="font-size: 5rem; color: #6c757d;"></i>
            </div>
            <h4 class="text-muted mb-3">Aún no tienes pedidos</h4>
            <p class="text-muted mb-4">¡Explora nuestro catálogo y realiza tu primera compra!</p>
            <a href="catalogo.html" class="btn btn-success btn-lg">
                <i class="bi bi-shop me-2"></i>Ir al catálogo
            </a>
        </div>

        <!-- Lista de pedidos -->
        <div id="orders-container">
            <div id="orders-list" class="row g-4">
                <!-- Los pedidos se cargarán dinámicamente -->
            </div>
        </div>

        <!-- Filtros y búsqueda -->
        <div class="row mb-4" id="filters-section" style="display: none;">
            <div class="col-md-6">
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input type="text" class="form-control" id="search-orders" placeholder="Buscar por número de pedido o producto...">
                </div>
            </div>
            <div class="col-md-3">
                <select class="form-select" id="filter-status">
                    <option value="">Todos los estados</option>
                    <option value="Confirmado">Confirmado</option>
                    <option value="Preparando">Preparando</option>
                    <option value="En camino">En camino</option>
                    <option value="Entregado">Entregado</option>
                    <option value="Cancelado">Cancelado</option>
                </select>
            </div>
            <div class="col-md-3">
                <select class="form-select" id="filter-date">
                    <option value="">Todas las fechas</option>
                    <option value="7">Últimos 7 días</option>
                    <option value="30">Último mes</option>
                    <option value="90">Últimos 3 meses</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Footer Container -->
    <div id="footer-container"></div>

    <!-- Modal de detalles del pedido -->
    <div class="modal fade" id="orderDetailModal" tabindex="-1" aria-labelledby="orderDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="orderDetailModalLabel">
                        <i class="bi bi-receipt me-2"></i>Detalles del Pedido
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="orderDetailContent">
                    <!-- Contenido dinámico -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-success" id="reorderBtn" onclick="reorder()">
                        <i class="bi bi-arrow-repeat me-1"></i>Volver a pedir
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/app.js"></script>
    <script src="assets/js/footer.js"></script>
    
    <script>
        let currentUser = null;
        let orders = [];
        let filteredOrders = [];
        
        // Inicializar página
        document.addEventListener('DOMContentLoaded', function() {
            checkUserAuthentication();
            loadOrders();
            setupFilters();
            updateCartCount();
        });

        // Verificar autenticación del usuario
        function checkUserAuthentication() {
            const loggedUser = localStorage.getItem('ecomarket_current_user');
            if (loggedUser) {
                currentUser = JSON.parse(loggedUser);
                document.getElementById('not-logged-in').style.display = 'none';
                document.getElementById('orders-container').style.display = 'block';
                document.getElementById('filters-section').style.display = 'flex';
            } else {
                document.getElementById('not-logged-in').style.display = 'block';
                document.getElementById('orders-container').style.display = 'none';
                document.getElementById('filters-section').style.display = 'none';
            }
        }

        // Cargar pedidos del usuario
        function loadOrders() {
            if (!currentUser) return;
            
            const allOrders = JSON.parse(localStorage.getItem('ecomarket_orders')) || [];
            orders = allOrders.filter(order => order.userId === currentUser.id);
            filteredOrders = [...orders];
            
            if (orders.length === 0) {
                document.getElementById('empty-orders').style.display = 'block';
                document.getElementById('orders-list').style.display = 'none';
            } else {
                document.getElementById('empty-orders').style.display = 'none';
                document.getElementById('orders-list').style.display = 'flex';
                renderOrders(filteredOrders);
            }
        }

        // Renderizar lista de pedidos
        function renderOrders(ordersToRender) {
            const container = document.getElementById('orders-list');
            
            if (ordersToRender.length === 0) {
                container.innerHTML = `
                    <div class="col-12 text-center py-4">
                        <p class="text-muted">No se encontraron pedidos que coincidan con los filtros.</p>
                    </div>
                `;
                return;
            }

            const ordersHTML = ordersToRender.map(order => createOrderCard(order)).join('');
            container.innerHTML = ordersHTML;
        }

        // Crear card de pedido
        function createOrderCard(order) {
            const orderDate = new Date(order.date).toLocaleDateString('es-ES', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            const statusClass = {
                'Confirmado': 'bg-info',
                'Preparando': 'bg-warning',
                'En camino': 'bg-primary',
                'Entregado': 'bg-success',
                'Cancelado': 'bg-danger'
            }[order.status] || 'bg-secondary';

            const itemCount = order.items.reduce((sum, item) => sum + item.quantity, 0);

            return `
                <div class="col-lg-6 col-xl-4">
                    <div class="card border-0 shadow-sm h-100" style="border-radius: 16px;">
                        <div class="card-header bg-light d-flex justify-content-between align-items-center" style="border-radius: 16px 16px 0 0;">
                            <div>
                                <h6 class="mb-0 fw-bold">Pedido #${order.id}</h6>
                                <small class="text-muted">${orderDate}</small>
                            </div>
                            <span class="badge ${statusClass}">${order.status}</span>
                        </div>
                        <div class="card-body p-3">
                            <div class="d-flex align-items-center mb-3">
                                <i class="bi bi-bag-check text-success me-2 fs-4"></i>
                                <div>
                                    <div class="fw-semibold">${itemCount} producto${itemCount !== 1 ? 's' : ''}</div>
                                    <small class="text-muted">Total: ${order.total}</small>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="bi bi-credit-card text-muted me-2"></i>
                                    <span class="small">
                                        ${order.paymentMethod === 'credit' ? 'Tarjeta de crédito' : 
                                          order.paymentMethod === 'transfer' ? 'Transferencia bancaria' : 
                                          'Pago contra entrega'}
                                    </span>
                                </div>
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-geo-alt text-muted me-2"></i>
                                    <span class="small">${order.shipping.address}, ${order.shipping.city}</span>
                                </div>
                            </div>
                            
                            <div class="d-grid gap-2">
                                <button class="btn btn-outline-success btn-sm" onclick="showOrderDetail('${order.id}')">
                                    <i class="bi bi-eye me-1"></i>Ver detalles
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Mostrar detalles del pedido
        function showOrderDetail(orderId) {
            const order = orders.find(o => o.id == orderId);
            if (!order) return;

            const orderDate = new Date(order.date).toLocaleDateString('es-ES', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            const products = JSON.parse(localStorage.getItem('ecomarket_products')) || [];
            const itemsHTML = order.items.map(item => {
                const product = products.find(p => p.id === item.productId);
                if (!product) return '';
                
                const itemTotal = product.price * item.quantity;
                return `
                    <div class="d-flex align-items-center py-2 border-bottom">
                        <img src="${product.image}" class="me-3" style="width: 50px; height: 50px; object-fit: cover; border-radius: 8px;" alt="${product.name}">
                        <div class="flex-grow-1">
                            <h6 class="mb-1">${product.name}</h6>
                            <small class="text-muted">Cantidad: ${item.quantity} ${product.unit}</small>
                        </div>
                        <div class="text-end">
                            <div class="fw-bold">$${itemTotal.toLocaleString()}</div>
                            <small class="text-muted">$${product.price.toLocaleString()} c/u</small>
                        </div>
                    </div>
                `;
            }).join('');

            const modalContent = `
                <div class="row">
                    <div class="col-md-8">
                        <h6 class="mb-3">Productos</h6>
                        <div class="mb-4">
                            ${itemsHTML}
                        </div>
                    </div>
                    <div class="col-md-4">
                        <h6 class="mb-3">Información del pedido</h6>
                        <div class="mb-3">
                            <strong>Número:</strong> #${order.id}<br>
                            <strong>Fecha:</strong> ${orderDate}<br>
                            <strong>Estado:</strong> <span class="badge bg-success">${order.status}</span><br>
                            <strong>Total:</strong> ${order.total}
                        </div>
                        
                        <h6 class="mb-2">Datos de envío</h6>
                        <div class="mb-3">
                            <strong>${order.shipping.name}</strong><br>
                            ${order.shipping.phone}<br>
                            ${order.shipping.address}<br>
                            ${order.shipping.city}
                            ${order.shipping.postal ? `, CP: ${order.shipping.postal}` : ''}
                        </div>
                        
                        <h6 class="mb-2">Método de pago</h6>
                        <p>${order.paymentMethod === 'credit' ? 'Tarjeta de crédito' : 
                            order.paymentMethod === 'transfer' ? 'Transferencia bancaria' : 
                            'Pago contra entrega'}</p>
                    </div>
                </div>
            `;

            document.getElementById('orderDetailContent').innerHTML = modalContent;
            document.getElementById('reorderBtn').setAttribute('data-order-id', orderId);
            
            const modal = new bootstrap.Modal(document.getElementById('orderDetailModal'));
            modal.show();
        }

        // Volver a pedir
        function reorder() {
            const orderId = document.getElementById('reorderBtn').getAttribute('data-order-id');
            const order = orders.find(o => o.id == orderId);
            if (!order) return;

            // Agregar productos al carrito
            let cart = JSON.parse(localStorage.getItem('ecomarket_cart')) || [];
            
            order.items.forEach(item => {
                const existingItem = cart.find(cartItem => cartItem.productId === item.productId);
                if (existingItem) {
                    existingItem.quantity += item.quantity;
                } else {
                    cart.push({
                        productId: item.productId,
                        quantity: item.quantity,
                        addedAt: new Date().toISOString()
                    });
                }
            });

            localStorage.setItem('ecomarket_cart', JSON.stringify(cart));
            
            showToast('Productos agregados al carrito', 'success');
            updateCartCount();
            
            // Cerrar modal
            bootstrap.Modal.getInstance(document.getElementById('orderDetailModal')).hide();
        }

        // Configurar filtros
        function setupFilters() {
            document.getElementById('search-orders').addEventListener('input', applyFilters);
            document.getElementById('filter-status').addEventListener('change', applyFilters);
            document.getElementById('filter-date').addEventListener('change', applyFilters);
        }

        // Aplicar filtros
        function applyFilters() {
            const searchTerm = document.getElementById('search-orders').value.toLowerCase();
            const statusFilter = document.getElementById('filter-status').value;
            const dateFilter = parseInt(document.getElementById('filter-date').value);

            filteredOrders = orders.filter(order => {
                // Filtro de búsqueda
                const matchesSearch = searchTerm === '' || 
                    order.id.toString().includes(searchTerm) ||
                    order.items.some(item => {
                        const products = JSON.parse(localStorage.getItem('ecomarket_products')) || [];
                        const product = products.find(p => p.id === item.productId);
                        return product && product.name.toLowerCase().includes(searchTerm);
                    });

                // Filtro de estado
                const matchesStatus = statusFilter === '' || order.status === statusFilter;

                // Filtro de fecha
                let matchesDate = true;
                if (dateFilter) {
                    const orderDate = new Date(order.date);
                    const daysAgo = new Date();
                    daysAgo.setDate(daysAgo.getDate() - dateFilter);
                    matchesDate = orderDate >= daysAgo;
                }

                return matchesSearch && matchesStatus && matchesDate;
            });

            renderOrders(filteredOrders);
        }

        // Actualizar contador del carrito
        function updateCartCount() {
            const cart = JSON.parse(localStorage.getItem('ecomarket_cart')) || [];
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            const cartCountElement = document.getElementById('cart-count');
            if (cartCountElement) {
                cartCountElement.textContent = totalItems;
                cartCountElement.style.display = totalItems > 0 ? 'block' : 'none';
            }
        }

        // Mostrar notificación
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = 'toast-notification';
            
            const iconClass = {
                'success': 'bi-check-circle-fill text-success',
                'error': 'bi-x-circle-fill text-danger',
                'warning': 'bi-exclamation-triangle-fill text-warning',
                'info': 'bi-info-circle-fill text-info'
            }[type];
            
            toast.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="bi ${iconClass} me-2"></i>
                    <span>${message}</span>
                </div>
            `;
            toast.style.cssText = `
                position: fixed;
                top: 100px;
                right: 20px;
                background: white;
                padding: 15px 20px;
                border-radius: 12px;
                box-shadow: 0 8px 25px rgba(0,0,0,0.15);
                z-index: 1050;
                animation: slideInRight 0.3s ease;
                border-left: 4px solid ${type === 'success' ? '#28a745' : '#dc3545'};
                min-width: 300px;
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }
    </script>

    <style>
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        .card:hover {
            transform: translateY(-4px);
            transition: all 0.3s ease;
        }

        .badge {
            font-size: 0.75rem;
        }

        @media (max-width: 768px) {
            .container {
                margin-top: 60px !important;
            }
        }
    </style>
</body>
</html>
